From d9ff76ef46f2dc75315ffcc183da3719a2005f70 Mon Sep 17 00:00:00 2001
From: Peiyuan Song <squallatf@gmail.com>
Date: Mon, 24 Mar 2025 10:27:45 +0800
Subject: [PATCH] on windows, mimalloc should be loaded before other libraries.

---
 CMakeLists.txt | 7 ++++++-
 1 file changed, 6 insertions(+), 1 deletion(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index 228fcb4e..b9ea9312 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -192,7 +192,12 @@ cmake_dependent_option(
 if(MOLD_USE_MIMALLOC)
   if(MOLD_USE_SYSTEM_MIMALLOC)
     find_package(mimalloc REQUIRED)
-    target_link_libraries(mold PRIVATE mimalloc)
+    if (WIN32)
+      get_target_property(libraries mold LINK_LIBRARIES)
+      set_property(TARGET mold PROPERTY LINK_LIBRARIES "mimalloc;${libraries}")
+    else()
+      target_link_libraries(mold PRIVATE mimalloc)
+    endif()
   else()
     function(mold_add_mimalloc)
       set(MI_BUILD_STATIC ON CACHE INTERNAL "")
-- 
2.49.0.windows.1

